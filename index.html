<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>投資信託リバランス提案アプリ</title>
    <!-- Tailwind CSSを読み込み -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js（グラフ描画ライブラリ）を読み込み -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts (Inter) を読み込み -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
        }
        /* テーブルの入力欄のスタイル */
        .input-cell {
            padding: 0;
            border: 1px solid #e2e8f0;
            width: 80px;
        }
        .input-cell input {
            width: 100%;
            height: 100%;
            padding: 0.5rem;
            text-align: center;
            border: none;
            outline: none;
            background-color: transparent;
        }
        .header-cell {
            padding: 0.5rem;
            background-color: #f8fafc;
            font-weight: 600;
            text-align: center;
            white-space: nowrap;
        }
        .fund-name-cell {
            padding: 0.5rem;
            border: 1px solid #e2e8f0;
            text-align: left;
            min-width: 200px;
            font-weight: 500;
            background-color: #f8fafc;
        }
        /* ボタンのスタイル */
        .calc-button {
            transition: all 0.3s ease;
        }
        .calc-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        /* 強調表示用のセル */
        .highlight-cell {
            background-color: #eef2ff; /* light-indigo */
        }
        .highlight-cell input {
            background-color: #eef2ff;
        }
        .highlight-header {
            background-color: #c7d2fe; /* darker-indigo */
        }
        /* 読み取り専用セルのスタイル */
        .readonly-cell {
            background-color: #f1f5f9;
            color: #64748b;
            font-weight: 500;
        }
        .readonly-cell input {
            background-color: #f1f5f9;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">投資信託リバランス提案アプリ</h1>
            <p class="mt-2 text-gray-600">ポートフォリオを分析し、最適な投資配分を計算します。</p>
        </header>

        <main class="space-y-8">
            <!-- 1. データ入力セクション -->
            <section class="bg-white p-6 rounded-xl shadow-md">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-2">1. データ入力</h2>
                
                <div class="overflow-x-auto">
                    <h3 class="text-lg font-semibold mb-2">ポートフォリオ構成と資産状況</h3>
                    <table id="main-input-table" class="w-full border-collapse text-sm">
                        <!-- テーブル内容はJSで動的に生成 -->
                    </table>
                </div>
                <div class="mt-4 flex gap-2">
                     <button id="add-fund-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 text-sm">投資信託を追加</button>
                     <button id="add-country-btn" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 text-sm">国・地域を追加</button>
                </div>

                 <!-- NISA投資枠の設定 -->
                <div class="mt-8">
                    <h3 class="text-lg font-semibold mb-2">NISA投資枠の設定 (月額)</h3>
                    <div class="grid sm:grid-cols-2 gap-4">
                        <div class="bg-gray-100 p-4 rounded-lg">
                            <label for="tsumitate-investment" class="block font-medium text-gray-700">つみたて投資枠</label>
                            <input type="number" id="tsumitate-investment" value="100000" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                            <p class="text-xs text-gray-500 mt-1">この金額が、以下の割合で自動的に積み立てられます。</p>
                            <div id="tsumitate-allocation" class="mt-2 space-y-2 text-sm">
                                <!-- つみたて割合入力欄はJSで動的に生成 -->
                            </div>
                        </div>
                        <div class="bg-gray-100 p-4 rounded-lg">
                            <label for="growth-investment" class="block font-medium text-gray-700">成長投資枠</label>
                            <input type="number" id="growth-investment" value="100000" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                            <p class="text-xs text-gray-500 mt-1">この金額の最適な配分を計算します。</p>
                        </div>
                    </div>
                </div>

                <div class="text-center mt-8">
                    <button id="calculate-btn" class="calc-button bg-indigo-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        計算を実行する
                    </button>
                </div>
            </section>

            <!-- 2. 計算結果セクション -->
            <section id="result-section" class="bg-white p-6 rounded-xl shadow-md hidden">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-2">2. 計算結果</h2>
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8 items-start">
                    <!-- 現在のポートフォリオ -->
                    <div class="text-center">
                        <h3 class="text-lg font-semibold mb-2">現在 (As-Is)</h3>
                        <div class="w-full h-64 mx-auto"><canvas id="current-pie-chart"></canvas></div>
                        <div id="current-portfolio-summary" class="mt-4 text-sm"></div>
                    </div>
                    <!-- 提案 -->
                    <div class="lg:col-span-1 md:col-span-2 bg-indigo-50 p-6 rounded-lg">
                        <h3 class="text-lg font-semibold mb-2 text-indigo-800">成長投資枠の最適配分案</h3>
                        <p class="text-sm text-gray-600 mb-4">目標に近づけるための、今月の成長投資枠の購入プランです。</p>
                        <div id="rebalance-proposal" class="space-y-2"></div>
                    </div>
                    <!-- 1ヶ月後のポートフォリオ -->
                    <div class="text-center">
                        <h3 class="text-lg font-semibold mb-2">1ヶ月後 (To-Be)</h3>
                        <div class="w-full h-64 mx-auto"><canvas id="future-pie-chart"></canvas></div>
                        <div id="future-portfolio-summary" class="mt-4 text-sm"></div>
                    </div>
                </div>
            </section>
        </main>
        
        <footer class="text-center mt-12 text-sm text-gray-500">
            <p>&copy; 2024 Portfolio Rebalancer. All Rights Reserved.</p>
        </footer>
    </div>

    <script>
        // --- グローバル変数 ---
        let funds = ['オルカン', 'FANG+', '新興国インデックス', '先進国（除く米国）', '世界小型株（除く米国）'];
        let countries = ['日本', '米国', '欧州', '新興国', 'その他'];
        let charts = { current: null, future: null };

        // --- 初期化処理 ---
        document.addEventListener('DOMContentLoaded', () => {
            renderTables();
            setupEventListeners();
        });

        // --- テーブル描画 ---
        function renderTables() {
            renderMainTable();
            renderTsumitateAllocation();
        }

        function renderMainTable() {
            const table = document.getElementById('main-input-table');
            table.innerHTML = ''; // テーブルをクリア

            // ヘッダー
            const thead = table.createTHead();
            const headerRow = thead.insertRow();
            headerRow.innerHTML = `<th class="header-cell">投資信託 / 構成比(%)</th>` +
                countries.map(c => `<th class="header-cell">${c}</th>`).join('') +
                `<th class="header-cell highlight-header">保有資産額(円)</th>`;

            // ボディ (各投資信託の行)
            const tbody = table.createTBody();
            funds.forEach(fund => {
                const row = tbody.insertRow();
                let rowHTML = `<td class="fund-name-cell"><input type="text" value="${fund}" class="w-full bg-transparent outline-none" onchange="updateFundName(this, '${fund}')"></td>`;
                
                rowHTML += countries.map(country => {
                    if (country === 'その他') {
                        return `<td class="input-cell readonly-cell"><input type="number" data-fund="${fund}" data-country="${country}" value="0" readonly></td>`;
                    } else {
                        return `<td class="input-cell"><input type="number" data-fund="${fund}" data-country="${country}" value="${getInitialComposition(fund, country)}" oninput="autoCalculateOther(this.closest('tr'))"></td>`;
                    }
                }).join('');
                
                rowHTML += `<td class="input-cell highlight-cell"><input type="number" id="asset-${fund}" value="1000000"></td>`;
                row.innerHTML = rowHTML;
            });

            // フッター (目標割合の行)
            const tfoot = table.createTFoot();
            const targetRow = tfoot.insertRow();
            let targetRowHTML = `<td class="fund-name-cell">目標割合 (%)</td>`;
            targetRowHTML += countries.map(c => `<td class="input-cell highlight-cell"><input type="number" id="target-${c}" value="${(100 / countries.length).toFixed(1)}"></td>`).join('');
            targetRowHTML += `<td class="highlight-cell"></td>`; // 右端の空セル
            targetRow.innerHTML = targetRowHTML;

            // 「その他」の初期値を計算
            tbody.querySelectorAll('tr').forEach(row => autoCalculateOther(row));
        }

        function autoCalculateOther(row) {
            let total = 0;
            const otherInput = row.querySelector('input[data-country="その他"]');
            
            countries.forEach(country => {
                if (country !== 'その他') {
                    const input = row.querySelector(`input[data-country="${country}"]`);
                    if (input) {
                        total += parseFloat(input.value) || 0;
                    }
                }
            });

            if (otherInput) {
                const otherValue = 100 - total;
                otherInput.value = otherValue.toFixed(1);
            }
        }

        function renderTsumitateAllocation() {
            const container = document.getElementById('tsumitate-allocation');
            container.innerHTML = funds.map(fund => `
                <div class="flex items-center justify-between">
                    <label for="tsumitate-alloc-${fund}" class="text-gray-600">${fund}</label>
                    <input type="number" id="tsumitate-alloc-${fund}" class="w-20 text-right p-1 border rounded-md" value="${(100 / funds.length).toFixed(1)}">
                </div>
            `).join('');
        }
        
        // --- イベントリスナー設定 ---
        function setupEventListeners() {
            document.getElementById('add-fund-btn').addEventListener('click', addFund);
            document.getElementById('add-country-btn').addEventListener('click', addCountry);
            document.getElementById('calculate-btn').addEventListener('click', executeCalculation);
        }

        // --- データ更新・追加処理 ---
        function updateFundName(inputElement, oldName) {
            const newName = inputElement.value.trim();
            if (newName && !funds.includes(newName)) {
                const index = funds.indexOf(oldName);
                funds[index] = newName;
                renderTables(); // 名前が変わったので全体を再描画
            } else {
                inputElement.value = oldName; // 重複または空の場合は元に戻す
            }
        }

        function addFund() {
            const fundName = prompt('追加する投資信託名を入力してください:');
            if (fundName && !funds.includes(fundName)) {
                funds.push(fundName);
                renderTables();
            } else if (fundName) {
                alert('その名前は既に使用されています。');
            }
        }

        function addCountry() {
            const countryName = prompt('追加する国・地域名を入力してください:');
            if (countryName && !countries.includes(countryName) && countryName !== 'その他') {
                // 「その他」の前に新しい国を追加
                countries.splice(countries.length - 1, 0, countryName);
                renderTables();
            } else if (countryName) {
                alert('その名前は既に使用されているか、予約されています。');
            }
        }
        
        // --- 計算実行 ---
        function executeCalculation() {
            const data = parseInputs();
            if (!data) return;

            // 1. 現状分析
            const currentPortfolio = calculateCurrentPortfolio(data);
            displayPortfolio('current', '現在のポートフォリオ', currentPortfolio, data.targets);

            // 2. 最適化計算
            const optimalAllocation = findOptimalAllocation(data, currentPortfolio);
            displayProposal(optimalAllocation, data.growthInvestment);

            // 3. 1ヶ月後予測
            const futurePortfolio = calculateFuturePortfolio(data, currentPortfolio, optimalAllocation);
            displayPortfolio('future', '1ヶ月後のポートフォリオ', futurePortfolio, data.targets);

            document.getElementById('result-section').classList.remove('hidden');
        }

        // --- 入力データ解析 ---
        function parseInputs() {
            const compositions = {};
            let validationError = false;
            funds.forEach(fund => {
                if (validationError) return;
                compositions[fund] = {};
                let total = 0;
                countries.forEach(country => {
                    const input = document.querySelector(`input[data-fund="${fund}"][data-country="${country}"]`);
                    const val = parseFloat(input.value) || 0;
                    compositions[fund][country] = val / 100;
                    total += val;
                });
                if (Math.abs(total - 100) > 0.1) {
                    alert(`${fund} の構成割合の合計が100%になりません。(現在: ${total.toFixed(1)}%)`);
                    validationError = true;
                }
            });
            if(validationError) return null;


            const assets = {};
            funds.forEach(fund => {
                assets[fund] = parseFloat(document.getElementById(`asset-${fund}`).value) || 0;
            });

            const targets = {};
            let targetTotal = 0;
            countries.forEach(country => {
                const val = parseFloat(document.getElementById(`target-${country}`).value) || 0;
                targets[country] = val / 100;
                targetTotal += val;
            });
            if (Math.abs(targetTotal - 100) > 0.1) {
                alert(`目標割合の合計が100%になりません。(現在: ${targetTotal.toFixed(1)}%)`);
                return null;
            }
            
            const tsumitateAllocation = {};
            let tsumitateTotal = 0;
            funds.forEach(fund => {
                const val = parseFloat(document.getElementById(`tsumitate-alloc-${fund}`).value) || 0;
                tsumitateAllocation[fund] = val / 100;
                tsumitateTotal += val;
            });
            if (Math.abs(tsumitateTotal - 100) > 0.1) {
                alert(`つみたて投資枠の配分合計が100%になりません。(現在: ${tsumitateTotal.toFixed(1)}%)`);
                return null;
            }

            return {
                compositions,
                assets,
                targets,
                tsumitateInvestment: parseFloat(document.getElementById('tsumitate-investment').value) || 0,
                tsumitateAllocation,
                growthInvestment: parseFloat(document.getElementById('growth-investment').value) || 0,
            };
        }

        // --- ポートフォリオ計算ロジック ---
        function calculateCurrentPortfolio(data) {
            const portfolio = {
                totalAsset: 0,
                byCountry: {}
            };
            countries.forEach(c => portfolio.byCountry[c] = 0);

            funds.forEach(fund => {
                const asset = data.assets[fund];
                portfolio.totalAsset += asset;
                countries.forEach(country => {
                    portfolio.byCountry[country] += asset * data.compositions[fund][country];
                });
            });
            return portfolio;
        }

        function calculateFuturePortfolio(data, currentPortfolio, growthAllocation) {
            const futurePortfolio = {
                totalAsset: currentPortfolio.totalAsset + data.tsumitateInvestment + data.growthInvestment,
                byCountry: { ...currentPortfolio.byCountry }
            };

            // つみたて投資枠の加算
            funds.forEach(fund => {
                const tsumitateAmount = data.tsumitateInvestment * data.tsumitateAllocation[fund];
                countries.forEach(country => {
                    futurePortfolio.byCountry[country] += tsumitateAmount * data.compositions[fund][country];
                });
            });

            // 成長投資枠の加算
            funds.forEach(fund => {
                const growthAmount = growthAllocation[fund] || 0;
                countries.forEach(country => {
                    futurePortfolio.byCountry[country] += growthAmount * data.compositions[fund][country];
                });
            });
            return futurePortfolio;
        }

        // --- 最適化アルゴリズム ---
        function findOptimalAllocation(data, currentPortfolio) {
            const { growthInvestment } = data;
            let bestAllocation = {};
            funds.forEach(f => bestAllocation[f] = growthInvestment / funds.length); // 初期値は均等配分
            let minError = calculateError(data, currentPortfolio, bestAllocation);

            const iterations = 30000;
            const step = Math.max(1, growthInvestment / 1000); 

            for (let i = 0; i < iterations; i++) {
                const tempAllocation = { ...bestAllocation };
                
                if (funds.length < 2) break;
                const fund1 = funds[Math.floor(Math.random() * funds.length)];
                const fund2 = funds[Math.floor(Math.random() * funds.length)];
                if (fund1 === fund2) continue;

                if (tempAllocation[fund1] >= step) {
                    tempAllocation[fund1] -= step;
                    tempAllocation[fund2] += step;

                    const currentError = calculateError(data, currentPortfolio, tempAllocation);
                    if (currentError < minError) {
                        minError = currentError;
                        bestAllocation = tempAllocation;
                    }
                }
            }
            
            let total = 0;
            funds.forEach(f => {
                bestAllocation[f] = Math.round(bestAllocation[f]);
                total += bestAllocation[f];
            });
            
            let diff = growthInvestment - total;
            if (diff !== 0 && funds.length > 0) {
                const fundToAdjust = funds[Math.floor(Math.random() * funds.length)];
                bestAllocation[fundToAdjust] += diff;
            }

            return bestAllocation;
        }
        
        function calculateError(data, currentPortfolio, growthAllocation) {
            const futurePortfolio = calculateFuturePortfolio(data, currentPortfolio, growthAllocation);
            let error = 0;

            countries.forEach(country => {
                const futureRatio = futurePortfolio.totalAsset > 0 ? futurePortfolio.byCountry[country] / futurePortfolio.totalAsset : 0;
                const targetRatio = data.targets[country];
                error += Math.pow(futureRatio - targetRatio, 2);
            });
            return error;
        }

        // --- 結果表示 ---
        function displayPortfolio(type, title, portfolio, targets) {
            const summaryDiv = document.getElementById(`${type}-portfolio-summary`);
            let tableHTML = `<table class="w-full text-left mx-auto max-w-sm">
                <thead><tr class="border-b"><th class="py-1">国・地域</th><th class="py-1 text-right">割合</th><th class="py-1 text-right">目標との差</th></tr></thead><tbody>`;
            
            const labels = [];
            const chartData = [];
            
            countries.forEach(country => {
                const ratio = portfolio.totalAsset > 0 ? (portfolio.byCountry[country] / portfolio.totalAsset) * 100 : 0;
                const diff = ratio - (targets[country] * 100);
                const diffColor = diff >= 0 ? 'text-green-600' : 'text-red-600';
                const diffSign = diff >= 0 ? '+' : '';

                tableHTML += `<tr>
                    <td class="py-1">${country}</td>
                    <td class="py-1 text-right">${ratio.toFixed(2)}%</td>
                    <td class="py-1 text-right ${diffColor}">${diffSign}${diff.toFixed(2)}%</td>
                </tr>`;
                labels.push(country);
                chartData.push(portfolio.byCountry[country]);
            });
            tableHTML += `<tr class="border-t font-bold"><td class="py-1">合計</td><td class="py-1 text-right">${portfolio.totalAsset.toLocaleString()} 円</td><td></td></tr></tbody></table>`;
            summaryDiv.innerHTML = tableHTML;

            drawPieChart(type, labels, chartData);
        }
        
        function displayProposal(allocation, total) {
            const proposalDiv = document.getElementById('rebalance-proposal');
            let html = `<ul class="space-y-3">`;
            funds.forEach(fund => {
                const amount = allocation[fund] || 0;
                const percentage = total > 0 ? (amount / total * 100) : 0;
                html += `<li class="p-3 bg-white rounded-md shadow-sm">
                    <div class="flex justify-between items-center">
                        <span class="font-medium text-gray-800">${fund}</span>
                        <span class="font-semibold text-indigo-700">${amount.toLocaleString()} 円</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mt-1">
                        <div class="bg-indigo-500 h-2.5 rounded-full" style="width: ${percentage}%"></div>
                    </div>
                </li>`;
            });
            html += `</ul>`;
            proposalDiv.innerHTML = html;
        }

        function drawPieChart(type, labels, data) {
            const ctx = document.getElementById(`${type}-pie-chart`).getContext('2d');
            if (charts[type]) {
                charts[type].destroy();
            }
            charts[type] = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.8)', 'rgba(239, 68, 68, 0.8)', 'rgba(16, 185, 129, 0.8)',
                            'rgba(245, 158, 11, 0.8)', 'rgba(139, 92, 246, 0.8)', 'rgba(236, 72, 153, 0.8)',
                        ],
                        borderColor: 'rgba(255, 255, 255, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: { size: 12 }
                            }
                        }
                    }
                }
            });
        }
        
        // --- 初期データ設定（サンプル） ---
        function getInitialComposition(fund, country) {
            const compositions = {
                'オルカン': { '日本': 5.5, '米国': 62.2, '欧州': 15.8, '新興国': 11.1 },
                'FANG+': { '日本': 0, '米国': 100, '欧州': 0, '新興国': 0 },
                '新興国インデックス': { '日本': 0, '米国': 10, '欧州': 5, '新興国': 85 },
                '先進国（除く米国）': { '日本': 20, '米国': 0, '欧州': 60, '新興国': 10 },
                '世界小型株（除くインデックス）': { '日本': 10, '米国': 30, '欧州': 30, '新興国': 20 }
            };
            return compositions[fund] ? (compositions[fund][country] || 0) : 0;
        }

    </script>
</body>
</html>
